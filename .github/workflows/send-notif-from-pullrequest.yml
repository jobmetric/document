name: Telegram Notifications

on:
  # Trigger when "Build and Deploy" workflow completes
  workflow_run:
    workflows: ["Build and Deploy"]
    types:
      - completed
  # Trigger when new PR is opened
  pull_request:
    types:
      - opened

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification on PR
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi
          
          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO="\nğŸ“¢ *Channel:* $TELEGRAM_CHANNEL_LINK"
          fi
          
          # Build PR notification message
          MESSAGE="ğŸ“ *New Pull Request*\n\nğŸ“¦ *Repository:* \`${{ github.repository }}\`\nğŸ”¢ *PR Number:* #${{ github.event.pull_request.number }}\nğŸ“‹ *Title:* ${{ github.event.pull_request.title }}\nğŸ‘¤ *Author:* ${{ github.event.pull_request.user.login }}\nğŸŒ¿ *Branch:* \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`\nğŸ“ *Description:*\n${{ github.event.pull_request.body }}$CHANNEL_INFO\n\nğŸ”— *View PR:* ${{ github.event.pull_request.html_url }}"
          
          # Send message to Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      # Send notification for workflow completion (success/failure)
      - name: Send Telegram notification on workflow completion
        if: github.event_name == 'workflow_run'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            exit 0
          fi
          
          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO="\nğŸ“¢ *Channel:* $TELEGRAM_CHANNEL_LINK"
          fi
          
          # Get workflow run details
          WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          COMMIT_MSG="${{ github.event.workflow_run.head_commit.message }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          
          # Build success or failure message
          if [ "$WORKFLOW_CONCLUSION" == "success" ]; then
            MESSAGE="ğŸ‰ *Deployment Successful*\n\nğŸ“¦ *Repository:* \`${{ github.repository }}\`\nğŸŒ¿ *Branch:* \`$HEAD_BRANCH\`\nğŸ‘¤ *Author:* $ACTOR\nğŸ’¬ *Commit:* \`$COMMIT_MSG\`\nğŸ”— *Commit SHA:* \`$HEAD_SHA\`\nğŸ“… *Time:* $(date '+%Y-%m-%d %H:%M:%S UTC')$CHANNEL_INFO\n\nâœ… Build completed successfully\nâœ… Tests passed\nâœ… Deployed to: \`${{ secrets.TARGET_REPO }}\`\n\nğŸ”— *View Run:* $RUN_URL"
          else
            MESSAGE="âŒ *Deployment Failed*\n\nğŸ“¦ *Repository:* \`${{ github.repository }}\`\nğŸŒ¿ *Branch:* \`$HEAD_BRANCH\`\nğŸ‘¤ *Author:* $ACTOR\nğŸ’¬ *Commit:* \`$COMMIT_MSG\`\nğŸ”— *Commit SHA:* \`$HEAD_SHA\`\nğŸ“… *Time:* $(date '+%Y-%m-%d %H:%M:%S UTC')$CHANNEL_INFO\n\nâŒ *Status:* Build or deployment failed\nğŸ” *Conclusion:* $WORKFLOW_CONCLUSION\n\nğŸ“‹ *Possible reasons:*\nâ€¢ Build errors\nâ€¢ Test failures\nâ€¢ Deployment issues\nâ€¢ Missing dependencies\n\nğŸ”— *View Logs:* $RUN_URL"
          fi
          
          # Send message to Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true
          
          echo "ğŸ“± Telegram notification sent"
